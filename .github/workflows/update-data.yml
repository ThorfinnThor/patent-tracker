name: Weekly data update

on:
  workflow_dispatch:
  schedule:
    - cron: "0 6 * * 1" # Mondays 06:00 UTC

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Update datasets + build artifacts
        env:
          PATENTSVIEW_API_KEY: ${{ secrets.PATENTSVIEW_API_KEY }}
        run: |
          python scripts/update_all.py

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Load into Postgres (single-session staging + upsert)
        env:
          POSTGRES_URL: ${{ secrets.POSTGRES_URL }}
        run: |
          set -euo pipefail

          if [ -z "${POSTGRES_URL}" ]; then
            echo "Missing POSTGRES_URL secret"
            exit 1
          fi

          export PGCONNECT_TIMEOUT=10

          psql "${POSTGRES_URL}" -v ON_ERROR_STOP=1 << 'SQL'
          -- Core tables
          CREATE TABLE IF NOT EXISTS patents (
            sector TEXT NOT NULL,
            company_id TEXT NOT NULL,
            patent_id TEXT NOT NULL,
            patent_date DATE NOT NULL,
            patent_year INT NOT NULL,
            patent_title TEXT NOT NULL,
            cited_by INT NOT NULL,
            cpc_subclass_ids TEXT NOT NULL,
            cpc_group_ids TEXT NOT NULL,
            PRIMARY KEY (sector, company_id, patent_id)
          );

          CREATE INDEX IF NOT EXISTS idx_patents_company_date
            ON patents(sector, company_id, patent_date DESC, patent_id DESC);

          CREATE INDEX IF NOT EXISTS idx_patents_company_cited
            ON patents(sector, company_id, cited_by DESC, patent_date DESC);

          CREATE INDEX IF NOT EXISTS idx_patents_company_year
            ON patents(sector, company_id, patent_year DESC);

          CREATE TABLE IF NOT EXISTS companies (
            sector TEXT NOT NULL,
            company_id TEXT NOT NULL,
            display_name TEXT NOT NULL,
            patent_count INT NOT NULL,
            total_citations INT NOT NULL,
            citations_per_patent DOUBLE PRECISION NOT NULL,
            cpc_breadth INT NOT NULL,
            PRIMARY KEY (sector, company_id)
          );

          CREATE TABLE IF NOT EXISTS patent_inventors (
            sector TEXT NOT NULL,
            company_id TEXT NOT NULL,
            patent_id TEXT NOT NULL,
            inventor_id TEXT NOT NULL,
            inventor_name_first TEXT NOT NULL,
            inventor_name_last TEXT NOT NULL,
            inventor_name TEXT NOT NULL,
            patent_date DATE NOT NULL,
            PRIMARY KEY (sector, company_id, patent_id, inventor_id)
          );

          CREATE INDEX IF NOT EXISTS idx_pi_company_date
            ON patent_inventors(sector, company_id, patent_date DESC);

          -- CPC dictionaries
          CREATE TABLE IF NOT EXISTS cpc_group (
            cpc_group_id TEXT PRIMARY KEY,
            cpc_group_title TEXT NOT NULL
          );

          CREATE TABLE IF NOT EXISTS cpc_subclass (
            cpc_subclass_id TEXT PRIMARY KEY,
            cpc_subclass_title TEXT NOT NULL
          );

          CREATE TABLE IF NOT EXISTS cpc_class (
            cpc_class_id TEXT PRIMARY KEY,
            cpc_class_title TEXT NOT NULL
          );

          -- Staging tables
          CREATE TABLE IF NOT EXISTS patents_stage (
            sector TEXT,
            company_id TEXT,
            patent_id TEXT,
            patent_date DATE,
            patent_year INT,
            patent_title TEXT,
            cited_by INT,
            cpc_subclass_ids TEXT,
            cpc_group_ids TEXT
          );

          CREATE TABLE IF NOT EXISTS companies_stage (
            sector TEXT,
            "companyId" TEXT,
            "displayName" TEXT,
            "patentCount" INT,
            "totalCitations" INT,
            "citationsPerPatent" DOUBLE PRECISION,
            "cpcBreadth" INT
          );

          CREATE TABLE IF NOT EXISTS inventors_stage (
            sector TEXT,
            company_id TEXT,
            patent_id TEXT,
            inventor_id TEXT,
            inventor_name_first TEXT,
            inventor_name_last TEXT,
            inventor_name TEXT,
            patent_date DATE
          );

          CREATE TABLE IF NOT EXISTS cpc_group_stage (
            cpc_group_id TEXT,
            cpc_group_title TEXT
          );

          CREATE TABLE IF NOT EXISTS cpc_subclass_stage (
            cpc_subclass_id TEXT,
            cpc_subclass_title TEXT
          );

          CREATE TABLE IF NOT EXISTS cpc_class_stage (
            cpc_class_id TEXT,
            cpc_class_title TEXT
          );

          TRUNCATE patents_stage;
          TRUNCATE companies_stage;
          TRUNCATE inventors_stage;
          TRUNCATE cpc_group_stage;
          TRUNCATE cpc_subclass_stage;
          TRUNCATE cpc_class_stage;

          -- Load CSVs
          \copy patents_stage FROM 'data/state/postgres/biotech_patents.csv' WITH (FORMAT csv, HEADER true)
          \copy patents_stage FROM 'data/state/postgres/tech_patents.csv' WITH (FORMAT csv, HEADER true)

          \copy companies_stage FROM 'data/state/postgres/biotech_companies.csv' WITH (FORMAT csv, HEADER true)
          \copy companies_stage FROM 'data/state/postgres/tech_companies.csv' WITH (FORMAT csv, HEADER true)

          \copy inventors_stage FROM 'data/state/postgres/biotech_inventors.csv' WITH (FORMAT csv, HEADER true)
          \copy inventors_stage FROM 'data/state/postgres/tech_inventors.csv' WITH (FORMAT csv, HEADER true)

          \copy cpc_group_stage FROM 'data/state/postgres/cpc_group.csv' WITH (FORMAT csv, HEADER true)
          \copy cpc_subclass_stage FROM 'data/state/postgres/cpc_subclass.csv' WITH (FORMAT csv, HEADER true)
          \copy cpc_class_stage FROM 'data/state/postgres/cpc_class.csv' WITH (FORMAT csv, HEADER true)

          -- Upsert patents
          INSERT INTO patents (sector, company_id, patent_id, patent_date, patent_year, patent_title, cited_by, cpc_subclass_ids, cpc_group_ids)
          SELECT sector, company_id, patent_id, patent_date, patent_year, patent_title, cited_by, cpc_subclass_ids, cpc_group_ids
          FROM patents_stage
          ON CONFLICT (sector, company_id, patent_id)
          DO UPDATE SET
            patent_date = EXCLUDED.patent_date,
            patent_year = EXCLUDED.patent_year,
            patent_title = EXCLUDED.patent_title,
            cited_by = EXCLUDED.cited_by,
            cpc_subclass_ids = EXCLUDED.cpc_subclass_ids,
            cpc_group_ids = EXCLUDED.cpc_group_ids;

          -- Upsert companies
          INSERT INTO companies (sector, company_id, display_name, patent_count, total_citations, citations_per_patent, cpc_breadth)
          SELECT
            sector,
            "companyId" AS company_id,
            "displayName" AS display_name,
            "patentCount" AS patent_count,
            "totalCitations" AS total_citations,
            "citationsPerPatent" AS citations_per_patent,
            "cpcBreadth" AS cpc_breadth
          FROM companies_stage
          ON CONFLICT (sector, company_id)
          DO UPDATE SET
            display_name = EXCLUDED.display_name,
            patent_count = EXCLUDED.patent_count,
            total_citations = EXCLUDED.total_citations,
            citations_per_patent = EXCLUDED.citations_per_patent,
            cpc_breadth = EXCLUDED.cpc_breadth;

          -- Upsert inventors
          INSERT INTO patent_inventors (sector, company_id, patent_id, inventor_id, inventor_name_first, inventor_name_last, inventor_name, patent_date)
          SELECT sector, company_id, patent_id, inventor_id, inventor_name_first, inventor_name_last, inventor_name, patent_date
          FROM inventors_stage
          ON CONFLICT (sector, company_id, patent_id, inventor_id)
          DO UPDATE SET
            inventor_name_first = EXCLUDED.inventor_name_first,
            inventor_name_last = EXCLUDED.inventor_name_last,
            inventor_name = EXCLUDED.inventor_name,
            patent_date = EXCLUDED.patent_date;

          -- Upsert CPC dictionaries
          INSERT INTO cpc_group (cpc_group_id, cpc_group_title)
          SELECT cpc_group_id, cpc_group_title FROM cpc_group_stage
          ON CONFLICT (cpc_group_id) DO UPDATE SET cpc_group_title = EXCLUDED.cpc_group_title;

          INSERT INTO cpc_subclass (cpc_subclass_id, cpc_subclass_title)
          SELECT cpc_subclass_id, cpc_subclass_title FROM cpc_subclass_stage
          ON CONFLICT (cpc_subclass_id) DO UPDATE SET cpc_subclass_title = EXCLUDED.cpc_subclass_title;

          INSERT INTO cpc_class (cpc_class_id, cpc_class_title)
          SELECT cpc_class_id, cpc_class_title FROM cpc_class_stage
          ON CONFLICT (cpc_class_id) DO UPDATE SET cpc_class_title = EXCLUDED.cpc_class_title;
          SQL

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install web deps
        working-directory: apps/web
        run: npm ci || npm install

      - name: Build web
        working-directory: apps/web
        run: npm run build

      - name: Commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add data/state data/store apps/web/public/data

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Weekly data refresh"
          git push
